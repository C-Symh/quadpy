# -*- coding: utf-8 -*-
#
import numpy


def volume(tet):
    '''Computes the center of the circumsphere of
    '''
    a = tet[1, :] - tet[0, :]
    b = tet[2, :] - tet[0, :]
    c = tet[3, :] - tet[0, :]

    omega = numpy.dot(a, numpy.cross(b, c))

    # https://en.wikipedia.org/wiki/Tetrahedron#Volume
    cell_volumes = abs(omega) / 6.0
    return cell_volumes


def _transform_to_unit_tetrahedron(f, tetrahedron):
    '''Transformation

      x = x0 * N0(xi, eta, zeta) \
        + x1 * N1(xi, eta, zeta) \
        + x2 * N2(xi, eta, zeta) \
        + x3 * N2(xi, eta, zeta)

    with

      N0(xi, eta) = 1 - xi - eta - zeta,
      N1(xi, eta) = xi,
      N2(xi, eta) = eta.
      N3(xi, eta) = zeta.
    '''
    return lambda xi: f(
        + tetrahedron[0] * (1.0 - xi[0] - xi[1] - xi[2])
        + tetrahedron[1] * xi[0]
        + tetrahedron[2] * xi[1]
        + tetrahedron[3] * xi[2]
        )


def integrate(f, tetrahedron, rule):
    g = _transform_to_unit_tetrahedron(f, tetrahedron)
    out = 0.0
    for point, weight in zip(rule.points, rule.weights):
        out += weight * g(point)
    return volume(tetrahedron) * out


class Keast(object):
    '''
    https://people.sc.fsu.edu/~jburkardt/datasets/quadrature_rules_tet/quadrature_rules_tet.html
    '''
    def __init__(self, index):
        if index == 0:
            self.weights = [1.0]
            self.points = numpy.array([
                [0.25, 0.25, 0.25]
                ])
            self.degree = 0
        elif index == 1:
            self.weights = numpy.array([
                0.25,
                0.25,
                0.25,
                0.25,
                ])
            self.points = numpy.array([
                [0.5854101966249685, 0.1381966011250105, 0.1381966011250105],
                [0.1381966011250105, 0.1381966011250105, 0.1381966011250105],
                [0.1381966011250105, 0.1381966011250105, 0.5854101966249685],
                [0.1381966011250105, 0.5854101966249685, 0.1381966011250105],
                ])
            self.degree = 1
        elif index == 2:
            self.weights = numpy.array([
                -0.8,
                0.45,
                0.45,
                0.45,
                0.45,
                ])
            self.points = numpy.array([
                [0.25, 0.25, 0.25],
                [0.5, 1.0/6.0, 1.0/6.0],
                [1.0/6.0, 1.0/6.0, 1.0/6.0],
                [1.0/6.0, 1.0/6.0, 0.5],
                [1.0/6.0, 0.5, 1.0/6.0],
                ])
            self.degree = 2
        elif index == 3:
            self.weights = numpy.array([
                0.2177650698804054,
                0.2177650698804054,
                0.2177650698804054,
                0.2177650698804054,
                0.0214899534130631,
                0.0214899534130631,
                0.0214899534130631,
                0.0214899534130631,
                0.0214899534130631,
                0.0214899534130631,
                ])
            self.points = numpy.array([
                [0.5684305841968444, 0.1438564719343852, 0.1438564719343852],
                [0.1438564719343852, 0.1438564719343852, 0.1438564719343852],
                [0.1438564719343852, 0.1438564719343852, 0.5684305841968444],
                [0.1438564719343852, 0.5684305841968444, 0.1438564719343852],
                [0.0, 0.5, 0.5],
                [0.5, 0.0, 0.5],
                [0.5, 0.5, 0.0],
                [0.5, 0.0, 0.0],
                [0.0, 0.5, 0.0],
                [0.0, 0.0, 0.5],
                ])
            self.degree = 3
        elif index == 4:
            self.weights = numpy.array([
                -0.0789333333333333,
                0.0457333333333333,
                0.0457333333333333,
                0.0457333333333333,
                0.0457333333333333,
                0.1493333333333333,
                0.1493333333333333,
                0.1493333333333333,
                0.1493333333333333,
                0.1493333333333333,
                0.1493333333333333,
                ])
            self.points = numpy.array([
                [0.2500000000000000,  0.2500000000000000,  0.2500000000000000],
                [0.7857142857142857,  0.0714285714285714,  0.0714285714285714],
                [0.0714285714285714,  0.0714285714285714,  0.0714285714285714],
                [0.0714285714285714,  0.0714285714285714,  0.7857142857142857],
                [0.0714285714285714,  0.7857142857142857,  0.0714285714285714],
                [0.1005964238332008,  0.3994035761667992,  0.3994035761667992],
                [0.3994035761667992,  0.1005964238332008,  0.3994035761667992],
                [0.3994035761667992,  0.3994035761667992,  0.1005964238332008],
                [0.3994035761667992,  0.1005964238332008,  0.1005964238332008],
                [0.1005964238332008,  0.3994035761667992,  0.1005964238332008],
                [0.1005964238332008,  0.1005964238332008,  0.3994035761667992],
                ])
            self.degree = 4
        elif index == 5:
            self.weights = numpy.array([
                0.0190476190476190,
                0.0190476190476190,
                0.0190476190476190,
                0.0190476190476190,
                0.0190476190476190,
                0.0190476190476190,
                0.0885898247429807,
                0.0885898247429807,
                0.0885898247429807,
                0.0885898247429807,
                0.1328387466855907,
                0.1328387466855907,
                0.1328387466855907,
                0.1328387466855907,
                ])
            self.points = numpy.array([
                [0.0, 0.5, 0.5],
                [0.5, 0.0, 0.5],
                [0.5, 0.5, 0.0],
                [0.5, 0.0, 0.0],
                [0.0, 0.5, 0.0],
                [0.0, 0.0, 0.5],
                [0.6984197043243866, 0.1005267652252045, 0.1005267652252045],
                [0.1005267652252045, 0.1005267652252045, 0.1005267652252045],
                [0.1005267652252045, 0.1005267652252045, 0.6984197043243866],
                [0.1005267652252045, 0.6984197043243866, 0.1005267652252045],
                [0.0568813795204234, 0.3143728734931922, 0.3143728734931922],
                [0.3143728734931922, 0.3143728734931922, 0.3143728734931922],
                [0.3143728734931922, 0.3143728734931922, 0.0568813795204234],
                [0.3143728734931922, 0.0568813795204234, 0.3143728734931922],
                ])
            self.degree = 4
        elif index == 6:
            self.weights = numpy.array([
                0.1817020685825351,
                0.0361607142857143,
                0.0361607142857143,
                0.0361607142857143,
                0.0361607142857143,
                0.0698714945161738,
                0.0698714945161738,
                0.0698714945161738,
                0.0698714945161738,
                0.0656948493683187,
                0.0656948493683187,
                0.0656948493683187,
                0.0656948493683187,
                0.0656948493683187,
                0.0656948493683187,
                ])
            self.points = numpy.array([
                [0.2500000000000000, 0.2500000000000000, 0.2500000000000000],
                [0.0000000000000000, 0.3333333333333333, 0.3333333333333333],
                [0.3333333333333333, 0.3333333333333333, 0.3333333333333333],
                [0.3333333333333333, 0.3333333333333333, 0.0000000000000000],
                [0.3333333333333333, 0.0000000000000000, 0.3333333333333333],
                [0.7272727272727273, 0.0909090909090909, 0.0909090909090909],
                [0.0909090909090909, 0.0909090909090909, 0.0909090909090909],
                [0.0909090909090909, 0.0909090909090909, 0.7272727272727273],
                [0.0909090909090909, 0.7272727272727273, 0.0909090909090909],
                [0.4334498464263357, 0.0665501535736643, 0.0665501535736643],
                [0.0665501535736643, 0.4334498464263357, 0.0665501535736643],
                [0.0665501535736643, 0.0665501535736643, 0.4334498464263357],
                [0.0665501535736643, 0.4334498464263357, 0.4334498464263357],
                [0.4334498464263357, 0.0665501535736643, 0.4334498464263357],
                [0.4334498464263357, 0.4334498464263357, 0.0665501535736643],
                ])
            self.degree = 5
        elif index == 7:
            self.weights = numpy.array([
                0.0399227502581679,
                0.0399227502581679,
                0.0399227502581679,
                0.0399227502581679,
                0.0100772110553207,
                0.0100772110553207,
                0.0100772110553207,
                0.0100772110553207,
                0.0553571815436544,
                0.0553571815436544,
                0.0553571815436544,
                0.0553571815436544,
                0.0482142857142857,
                0.0482142857142857,
                0.0482142857142857,
                0.0482142857142857,
                0.0482142857142857,
                0.0482142857142857,
                0.0482142857142857,
                0.0482142857142857,
                0.0482142857142857,
                0.0482142857142857,
                0.0482142857142857,
                0.0482142857142857,
                ])
            self.points = numpy.array([
                [0.3561913862225449, 0.2146028712591517, 0.2146028712591517],
                [0.2146028712591517, 0.2146028712591517, 0.2146028712591517],
                [0.2146028712591517, 0.2146028712591517, 0.3561913862225449],
                [0.2146028712591517, 0.3561913862225449, 0.2146028712591517],
                [0.8779781243961660, 0.0406739585346113, 0.0406739585346113],
                [0.0406739585346113, 0.0406739585346113, 0.0406739585346113],
                [0.0406739585346113, 0.0406739585346113, 0.8779781243961660],
                [0.0406739585346113, 0.8779781243961660, 0.0406739585346113],
                [0.0329863295731731, 0.3223378901422757, 0.3223378901422757],
                [0.3223378901422757, 0.3223378901422757, 0.3223378901422757],
                [0.3223378901422757, 0.3223378901422757, 0.0329863295731731],
                [0.3223378901422757, 0.0329863295731731, 0.3223378901422757],
                [0.2696723314583159, 0.0636610018750175, 0.0636610018750175],
                [0.0636610018750175, 0.2696723314583159, 0.0636610018750175],
                [0.0636610018750175, 0.0636610018750175, 0.2696723314583159],
                [0.6030056647916491, 0.0636610018750175, 0.0636610018750175],
                [0.0636610018750175, 0.6030056647916491, 0.0636610018750175],
                [0.0636610018750175, 0.0636610018750175, 0.6030056647916491],
                [0.0636610018750175, 0.2696723314583159, 0.6030056647916491],
                [0.2696723314583159, 0.6030056647916491, 0.0636610018750175],
                [0.6030056647916491, 0.0636610018750175, 0.2696723314583159],
                [0.0636610018750175, 0.6030056647916491, 0.2696723314583159],
                [0.2696723314583159, 0.0636610018750175, 0.6030056647916491],
                [0.6030056647916491, 0.2696723314583159, 0.0636610018750175],
                ])
            self.degree = 6
        elif index == 8:
            self.weights = numpy.array([
                0.1095853407966528,
                0.0635996491464850,
                0.0635996491464850,
                0.0635996491464850,
                0.0635996491464850,
                -0.3751064406859797,
                -0.3751064406859797,
                -0.3751064406859797,
                -0.3751064406859797,
                0.0293485515784412,
                0.0293485515784412,
                0.0293485515784412,
                0.0293485515784412,
                0.0058201058201058,
                0.0058201058201058,
                0.0058201058201058,
                0.0058201058201058,
                0.0058201058201058,
                0.0058201058201058,
                0.1653439153439105,
                0.1653439153439105,
                0.1653439153439105,
                0.1653439153439105,
                0.1653439153439105,
                0.1653439153439105,
                0.1653439153439105,
                0.1653439153439105,
                0.1653439153439105,
                0.1653439153439105,
                0.1653439153439105,
                0.1653439153439105,
                ])
            self.points = numpy.array([
                [0.2500000000000000, 0.2500000000000000, 0.2500000000000000],
                [0.7653604230090441, 0.0782131923303186, 0.0782131923303186],
                [0.0782131923303186, 0.0782131923303186, 0.0782131923303186],
                [0.0782131923303186, 0.0782131923303186, 0.7653604230090441],
                [0.0782131923303186, 0.7653604230090441, 0.0782131923303186],
                [0.6344703500082868, 0.1218432166639044, 0.1218432166639044],
                [0.1218432166639044, 0.1218432166639044, 0.1218432166639044],
                [0.1218432166639044, 0.1218432166639044, 0.6344703500082868],
                [0.1218432166639044, 0.6344703500082868, 0.1218432166639044],
                [0.0023825066607383, 0.3325391644464206, 0.3325391644464206],
                [0.3325391644464206, 0.3325391644464206, 0.3325391644464206],
                [0.3325391644464206, 0.3325391644464206, 0.0023825066607383],
                [0.3325391644464206, 0.0023825066607383, 0.3325391644464206],
                [0.0, 0.5, 0.5],
                [0.5, 0.0, 0.5],
                [0.5, 0.5, 0.0],
                [0.5, 0.0, 0.0],
                [0.0, 0.5, 0.0],
                [0.0, 0.0, 0.5],
                [0.2, 0.1, 0.1],
                [0.1, 0.2, 0.1],
                [0.1, 0.1, 0.2],
                [0.6, 0.1, 0.1],
                [0.1, 0.6, 0.1],
                [0.1, 0.1, 0.6],
                [0.1, 0.2, 0.6],
                [0.2, 0.6, 0.1],
                [0.6, 0.1, 0.2],
                [0.1, 0.6, 0.2],
                [0.2, 0.1, 0.6],
                [0.6, 0.2, 0.1],
                ])
            self.degree = 7
        elif index == 9:
            self.weights = numpy.array([
                -0.2359620398477557,
                0.0244878963560562,
                0.0244878963560562,
                0.0244878963560562,
                0.0244878963560562,
                0.0039485206398261,
                0.0039485206398261,
                0.0039485206398261,
                0.0039485206398261,
                0.0263055529507371,
                0.0263055529507371,
                0.0263055529507371,
                0.0263055529507371,
                0.0263055529507371,
                0.0263055529507371,
                0.0829803830550589,
                0.0829803830550589,
                0.0829803830550589,
                0.0829803830550589,
                0.0829803830550589,
                0.0829803830550589,
                0.0254426245481023,
                0.0254426245481023,
                0.0254426245481023,
                0.0254426245481023,
                0.0254426245481023,
                0.0254426245481023,
                0.0254426245481023,
                0.0254426245481023,
                0.0254426245481023,
                0.0254426245481023,
                0.0254426245481023,
                0.0254426245481023,
                0.0134324384376852,
                0.0134324384376852,
                0.0134324384376852,
                0.0134324384376852,
                0.0134324384376852,
                0.0134324384376852,
                0.0134324384376852,
                0.0134324384376852,
                0.0134324384376852,
                0.0134324384376852,
                0.0134324384376852,
                0.0134324384376852,
                ])
            self.points = numpy.array([
                [0.2500000000000000, 0.2500000000000000, 0.2500000000000000],
                [0.6175871903000830, 0.1274709365666390, 0.1274709365666390],
                [0.1274709365666390, 0.1274709365666390, 0.1274709365666390],
                [0.1274709365666390, 0.1274709365666390, 0.6175871903000830],
                [0.1274709365666390, 0.6175871903000830, 0.1274709365666390],
                [0.9037635088221031, 0.0320788303926323, 0.0320788303926323],
                [0.0320788303926323, 0.0320788303926323, 0.0320788303926323],
                [0.0320788303926323, 0.0320788303926323, 0.9037635088221031],
                [0.0320788303926323, 0.9037635088221031, 0.0320788303926323],
                [0.4502229043567190, 0.0497770956432810, 0.0497770956432810],
                [0.0497770956432810, 0.4502229043567190, 0.0497770956432810],
                [0.0497770956432810, 0.0497770956432810, 0.4502229043567190],
                [0.0497770956432810, 0.4502229043567190, 0.4502229043567190],
                [0.4502229043567190, 0.0497770956432810, 0.4502229043567190],
                [0.4502229043567190, 0.4502229043567190, 0.0497770956432810],
                [0.3162695526014501, 0.1837304473985499, 0.1837304473985499],
                [0.1837304473985499, 0.3162695526014501, 0.1837304473985499],
                [0.1837304473985499, 0.1837304473985499, 0.3162695526014501],
                [0.1837304473985499, 0.3162695526014501, 0.3162695526014501],
                [0.3162695526014501, 0.1837304473985499, 0.3162695526014501],
                [0.3162695526014501, 0.3162695526014501, 0.1837304473985499],
                [0.0229177878448171, 0.2319010893971509, 0.2319010893971509],
                [0.2319010893971509, 0.0229177878448171, 0.2319010893971509],
                [0.2319010893971509, 0.2319010893971509, 0.0229177878448171],
                [0.5132800333608811, 0.2319010893971509, 0.2319010893971509],
                [0.2319010893971509, 0.5132800333608811, 0.2319010893971509],
                [0.2319010893971509, 0.2319010893971509, 0.5132800333608811],
                [0.2319010893971509, 0.0229177878448171, 0.5132800333608811],
                [0.0229177878448171, 0.5132800333608811, 0.2319010893971509],
                [0.5132800333608811, 0.2319010893971509, 0.0229177878448171],
                [0.2319010893971509, 0.5132800333608811, 0.0229177878448171],
                [0.0229177878448171, 0.2319010893971509, 0.5132800333608811],
                [0.5132800333608811, 0.0229177878448171, 0.2319010893971509],
                [0.7303134278075384, 0.0379700484718286, 0.0379700484718286],
                [0.0379700484718286, 0.7303134278075384, 0.0379700484718286],
                [0.0379700484718286, 0.0379700484718286, 0.7303134278075384],
                [0.1937464752488044, 0.0379700484718286, 0.0379700484718286],
                [0.0379700484718286, 0.1937464752488044, 0.0379700484718286],
                [0.0379700484718286, 0.0379700484718286, 0.1937464752488044],
                [0.0379700484718286, 0.7303134278075384, 0.1937464752488044],
                [0.7303134278075384, 0.1937464752488044, 0.0379700484718286],
                [0.1937464752488044, 0.0379700484718286, 0.7303134278075384],
                [0.0379700484718286, 0.1937464752488044, 0.7303134278075384],
                [0.7303134278075384, 0.0379700484718286, 0.1937464752488044],
                [0.1937464752488044, 0.7303134278075384, 0.0379700484718286],
                ])
            self.degree = 8
        else:
            raise ValueError('Illegal Keast index')
        return
